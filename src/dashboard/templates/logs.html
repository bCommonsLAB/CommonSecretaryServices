{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1 class="mb-4">System Logs</h1>
    
    <div class="row mb-3">
        <div class="col-12">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary active" data-filter="all">All</button>
                <button type="button" class="btn btn-outline-info" data-filter="INFO">Info</button>
                <button type="button" class="btn btn-outline-warning" data-filter="DEBUG">Debug</button>
                <button type="button" class="btn btn-outline-danger" data-filter="ERROR">Error</button>
            </div>
        </div>
    </div>

    <div class="row">
        {% for log_file, log_entries in log_files.items() %}
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">{{ log_file }}</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Level</th>
                                    <th>Source</th>
                                    <th>Processor</th>
                                    <th>Process ID</th>
                                    <th>Message</th>
                                    <th>Args</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for line in log_entries|reverse %}
                                    {% if line.strip() %}
                                        {% set parts = line.split(' - ', 4) %}
                                        {% if parts|length >= 5 %}
                                            {% set timestamp = parts[0] %}
                                            {% set level = parts[1].strip() %}
                                            {% set source = parts[2].strip('[]') %}
                                            {% set process_full = parts[3].strip('[]') %}
                                            {% set message_parts = parts[4].split(' - Args: ', 1) %}
                                            {% set message = message_parts[0] %}
                                            {% set args = message_parts[1] if message_parts|length > 1 else '' %}
                                            
                                            {# Parse processor and process ID #}
                                            {% if ' Process[' in process_full %}
                                                {% set processor = process_full.split(' Process[', 1)[0].strip('[]') %}
                                                {% set process_id = process_full.split(' Process[', 1)[1].rstrip(']') %}
                                            {% else %}
                                                {% set processor = process_full.strip('[]') %}
                                                {% set process_id = '' %}
                                            {% endif %}
                                            
                                            <tr class="log-entry" data-level="{{ level }}">
                                                <td>{{ timestamp }}</td>
                                                <td><span class="badge {% if level == 'INFO' %}bg-info{% elif level == 'DEBUG' %}bg-warning{% elif level == 'ERROR' %}bg-danger{% endif %}">{{ level }}</span></td>
                                                <td>{{ source }}</td>
                                                <td>{{ processor }}</td>
                                                <td><code>{{ process_id }}</code></td>
                                                <td>{{ message }}</td>
                                                <td>
                                                    {% if args %}
                                                        <span class="args-preview">{{ args[:100] }}{% if args|length > 100 %}...{% endif %}</span>
                                                        <button type="button" class="btn btn-sm btn-outline-secondary show-args" 
                                                                data-args='{{ args|replace("'", "&#39;")|safe }}'>
                                                            Details
                                                        </button>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="row mt-3">
        <div class="col-12">
            <form action="{{ url_for('main.clear_logs') }}" method="post" class="d-inline">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to clear all logs?')">
                    Clear Logs
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Native dialog for displaying args -->
<dialog id="argsDialog" class="args-dialog">
    <div class="dialog-content">
        <div class="dialog-header">
            <h5 class="dialog-title">Arguments Detail</h5>
            <button type="button" class="btn-close" aria-label="Close"></button>
        </div>
        <div class="dialog-body">
            <pre class="json-content" tabindex="0"></pre>
        </div>
        <div class="dialog-footer">
            <button type="button" class="btn btn-secondary close-dialog">Close</button>
        </div>
    </div>
</dialog>

<style>
.table {
    font-size: 0.9em;
}
.args-preview {
    font-family: monospace;
    font-size: 0.9em;
}
.json-content {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 4px;
    white-space: pre-wrap;
}
.badge {
    font-size: 0.8em;
    padding: 0.4em 0.6em;
}
code {
    font-size: 0.85em;
    background-color: #f8f9fa;
    padding: 0.2em 0.4em;
    border-radius: 3px;
}
.args-dialog {
    padding: 0;
    border: none;
    border-radius: 6px;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    max-width: 800px;
    width: 90%;
}
.args-dialog::backdrop {
    background: rgba(0, 0, 0, 0.5);
}
.dialog-content {
    display: flex;
    flex-direction: column;
    width: 100%;
}
.dialog-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
}
.dialog-title {
    margin: 0;
}
.dialog-body {
    padding: 1rem;
    max-height: 70vh;
    overflow-y: auto;
}
.dialog-footer {
    padding: 1rem;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const filterButtons = document.querySelectorAll('[data-filter]');
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const filter = this.dataset.filter;
            
            // Update active button
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Filter table rows
            const rows = document.querySelectorAll('.log-entry');
            rows.forEach(row => {
                if (filter === 'all' || row.dataset.level.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });

    // Args dialog functionality
    const dialog = document.getElementById('argsDialog');
    const jsonContent = dialog.querySelector('.json-content');
    const closeButton = dialog.querySelector('.btn-close');
    const closeDialogButton = dialog.querySelector('.close-dialog');
    let lastFocusedElement = null;

    // Close dialog handlers
    const closeDialog = () => {
        dialog.close();
        if (lastFocusedElement) {
            lastFocusedElement.focus();
        }
    };

    closeButton.addEventListener('click', closeDialog);
    closeDialogButton.addEventListener('click', closeDialog);
    dialog.addEventListener('click', (e) => {
        if (e.target === dialog) {
            closeDialog();
        }
    });

    // Handle keyboard events
    dialog.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeDialog();
        }
    });

    // Show args in dialog
    document.querySelectorAll('.show-args').forEach(button => {
        button.addEventListener('click', function() {
            lastFocusedElement = this;
            try {
                let argsStr = this.dataset.args;
                console.log('Raw args:', argsStr); // Debug output
                
                // Decode HTML entities
                argsStr = argsStr.replace(/&#39;/g, "'");
                console.log('Decoded args:', argsStr); // Debug output
                
                try {
                    const args = JSON.parse(argsStr);
                    console.log('Parsed JSON:', args); // Debug output
                    jsonContent.textContent = JSON.stringify(args, null, 2);
                } catch (e) {
                    console.log('First parse failed:', e); // Debug output
                    // Try replacing single quotes with double quotes
                    argsStr = argsStr.replace(/'/g, '"');
                    console.log('Converted quotes:', argsStr); // Debug output
                    
                    try {
                        const args = JSON.parse(argsStr);
                        console.log('Parsed JSON after quote conversion:', args); // Debug output
                        jsonContent.textContent = JSON.stringify(args, null, 2);
                    } catch (e2) {
                        console.log('Second parse failed:', e2); // Debug output
                        jsonContent.textContent = argsStr;
                    }
                }
                dialog.showModal();
                jsonContent.focus();
            } catch (error) {
                console.error('Error handling args:', error);
                jsonContent.textContent = 'Error parsing arguments: ' + this.dataset.args;
                dialog.showModal();
            }
        });
    });
});
</script>
{% endblock %} 
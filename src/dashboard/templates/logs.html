{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1 class="mb-4">System Logs</h1>
    
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary active" data-filter="all">All</button>
                <button type="button" class="btn btn-outline-info" data-filter="INFO">Info</button>
                <button type="button" class="btn btn-outline-warning" data-filter="DEBUG">Debug</button>
                <button type="button" class="btn btn-outline-danger" data-filter="ERROR">Error</button>
            </div>
        </div>
        <div class="col-md-6">
            <form class="d-flex" method="get">
                <input type="text" name="session_id" class="form-control me-2" placeholder="Filter by Session ID..." value="{{ request.args.get('session_id', '') }}">
                <button class="btn btn-outline-primary" type="submit">Filter</button>
                {% if request.args.get('session_id') %}
                    <a href="{{ url_for('logs.view_logs') }}" class="btn btn-outline-secondary ms-2">Clear</a>
                {% endif %}
            </form>
        </div>
    </div>

    <div class="row">
        {% for log_file, log_entries in log_files.items() %}
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">{{ log_file }}</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Level</th>
                                    <th>Source</th>
                                    <th>Processor</th>
                                    <th>Process ID</th>
                                    <th>Message</th>
                                    <th>Args</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for line in log_entries|reverse %}
                                    {% if line.strip() %}
                                        {% set parts = line.split(' - ', 4) %}
                                        {% if parts|length >= 5 %}
                                            {% set timestamp = parts[0] %}
                                            {% set level = parts[1].strip() %}
                                            {% set source = parts[2].strip('[]') %}
                                            {% set process_full = parts[3].strip('[]') %}
                                            {% set message_parts = parts[4].split(' - Args: ', 1) %}
                                            {% set message = message_parts[0] %}
                                            {% set args = message_parts[1] if message_parts|length > 1 else '' %}
                                            
                                            {# Parse processor and process ID #}
                                            {% if ' Process[' in process_full %}
                                                {% set processor = process_full.split(' Process[', 1)[0].strip('[]') %}
                                                {% set process_id = process_full.split(' Process[', 1)[1].rstrip(']') %}
                                            {% else %}
                                                {% set processor = process_full.strip('[]') %}
                                                {% set process_id = '' %}
                                            {% endif %}
                                            
                                            <tr class="log-entry" data-level="{{ level }}">
                                                <td>{{ timestamp }}</td>
                                                <td>
                                                    <span class="badge {{ 'bg-danger' if level == 'ERROR' else 'bg-info' if level == 'INFO' else 'bg-warning' if level == 'DEBUG' else 'bg-secondary' }}">
                                                        {{ level }}
                                                    </span>
                                                </td>
                                                <td><code>{{ source }}</code></td>
                                                <td>
                                                    <span class="badge bg-secondary">{{ processor }}</span>
                                                </td>
                                                <td>
                                                    <a href="{{ url_for('logs.view_logs', session_id=process_id) }}" class="text-decoration-none">
                                                        <code>{{ process_id }}</code>
                                                    </a>
                                                </td>
                                                <td>{{ message }}</td>
                                                <td>
                                                    {% if args %}
                                                        <pre class="mb-0"><code>{{ args }}</code></pre>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const buttons = document.querySelectorAll('[data-filter]');
    buttons.forEach(button => {
        button.addEventListener('click', function() {
            const filter = this.dataset.filter;
            const entries = document.querySelectorAll('.log-entry');
            
            // Update active state of buttons
            buttons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Filter entries
            entries.forEach(entry => {
                if (filter === 'all' || entry.dataset.level === filter) {
                    entry.style.display = '';
                } else {
                    entry.style.display = 'none';
                }
            });
        });
    });
});
</script>
{% endblock %} 
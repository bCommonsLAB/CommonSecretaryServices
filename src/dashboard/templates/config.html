{% extends "base.html" %}

{% block title %}Configuration - Processing Service{% endblock %}

{% block content %}
<h1>System Configuration</h1>

<div class="row mt-4">
    <div class="col-12">
        <!-- Configuration Form -->
        <div class="card">
            <div class="card-body">
                <form id="configForm" method="POST">
                    <!-- Server Settings -->
                    <h5 class="card-title mb-4">Server Settings</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="serverHost" class="form-label">Host</label>
                                <input type="text" class="form-control" id="serverHost" name="server.host" value="{{ config.get('server.host', '127.0.0.1') }}">
                            </div>
                            <div class="mb-3">
                                <label for="serverPort" class="form-label">Port</label>
                                <input type="number" class="form-control" id="serverPort" name="server.port" value="{{ config.get('server.port', 5000) }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="serverDebug" name="server.debug" {% if config.get('server.debug') %}checked{% endif %}>
                                <label class="form-check-label" for="serverDebug">Debug Mode</label>
                            </div>
                        </div>
                    </div>

                    <!-- YouTube Processor Settings -->
                    <h5 class="card-title mb-4">YouTube Processor Settings</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="youtubeMaxFileSize" class="form-label">Max File Size (MB)</label>
                                <input type="number" class="form-control" id="youtubeMaxFileSize" 
                                       name="processors.youtube.max_file_size" 
                                       value="{{ config.get('processors.youtube.max_file_size', 104857600) // 1048576 }}" 
                                       min="1" max="1000">
                            </div>
                            <div class="mb-3">
                                <label for="youtubeMaxDuration" class="form-label">Max Duration (minutes)</label>
                                <input type="number" class="form-control" id="youtubeMaxDuration" 
                                       name="processors.youtube.max_duration" 
                                       value="{{ config.get('processors.youtube.max_duration', 3600) // 60 }}" 
                                       min="1" max="180">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="youtubeTempDir" class="form-label">Temp Directory</label>
                                <input type="text" class="form-control" id="youtubeTempDir" 
                                       name="processors.youtube.temp_dir" 
                                       value="{{ config.get('processors.youtube.temp_dir', 'temp-processing/video') }}">
                            </div>
                            <div class="mb-3">
                                <label for="youtubeFormat" class="form-label">Audio Format</label>
                                <select class="form-select" id="youtubeFormat" 
                                        name="processors.youtube.ydl_opts.format">
                                    <option value="bestaudio/best" {% if config.get('processors.youtube.ydl_opts.format') == 'bestaudio/best' %}selected{% endif %} 
                                            title="Beste verfügbare Audioqualität">Beste Audioqualität</option>
                                    <option value="worstaudio/worst" {% if config.get('processors.youtube.ydl_opts.format') == 'worstaudio/worst' %}selected{% endif %}
                                            title="Niedrigste Audioqualität (kleinere Dateigröße)">Niedrigste Audioqualität</option>
                                    <option value="bestaudio[ext=m4a]" {% if config.get('processors.youtube.ydl_opts.format') == 'bestaudio[ext=m4a]' %}selected{% endif %}
                                            title="Beste M4A Qualität">Beste M4A</option>
                                    <option value="bestaudio[ext=mp3]" {% if config.get('processors.youtube.ydl_opts.format') == 'bestaudio[ext=mp3]' %}selected{% endif %}
                                            title="Beste MP3 Qualität">Beste MP3</option>
                                    <option value="bestaudio[abr<=128]" {% if config.get('processors.youtube.ydl_opts.format') == 'bestaudio[abr<=128]' %}selected{% endif %}
                                            title="Audio mit maximal 128kbps">Max 128kbps</option>
                                    <option value="bestaudio[abr<=64]" {% if config.get('processors.youtube.ydl_opts.format') == 'bestaudio[abr<=64]' %}selected{% endif %}
                                            title="Audio mit maximal 64kbps (kleinere Dateigröße)">Max 64kbps</option>
                                </select>
                                <div class="form-text">Wählen Sie das gewünschte Audioformat und die Qualität für YouTube-Downloads.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Audio Processor Settings -->
                    <h5 class="card-title mb-4">Audio Processor Settings</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="audioMaxFileSize" class="form-label">Max File Size (MB)</label>
                                <input type="number" class="form-control" id="audioMaxFileSize" 
                                       name="processors.audio.max_file_size" 
                                       value="{{ config.get('processors.audio.max_file_size', 104857600) // 1048576 }}" 
                                       min="1" max="1000">
                            </div>
                            <div class="mb-3">
                                <label for="audioSegmentDuration" class="form-label">Segment Duration (minutes)</label>
                                <input type="number" class="form-control" id="audioSegmentDuration" 
                                       name="processors.audio.segment_duration" 
                                       value="{{ config.get('processors.audio.segment_duration', 300) // 60 }}" 
                                       min="1" max="30">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="audioTempDir" class="form-label">Temp Directory</label>
                                <input type="text" class="form-control" id="audioTempDir" 
                                       name="processors.audio.temp_dir" 
                                       value="{{ config.get('processors.audio.temp_dir', 'temp-processing/audio') }}">
                            </div>
                            <div class="mb-3">
                                <label for="audioExportFormat" class="form-label">Export Format</label>
                                <select class="form-select" id="audioExportFormat" 
                                        name="processors.audio.export_format">
                                    <option value="mp3" {% if config.get('processors.audio.export_format') == 'mp3' %}selected{% endif %}
                                            title="MP3 - Weit verbreitetes Audioformat mit guter Kompression">MP3</option>
                                    <option value="wav" {% if config.get('processors.audio.export_format') == 'wav' %}selected{% endif %}
                                            title="WAV - Unkomprimiertes Audioformat in hoher Qualität">WAV</option>
                                    <option value="ogg" {% if config.get('processors.audio.export_format') == 'ogg' %}selected{% endif %}
                                            title="OGG - Freies Audioformat mit guter Kompression">OGG</option>
                                    <option value="m4a" {% if config.get('processors.audio.export_format') == 'm4a' %}selected{% endif %}
                                            title="M4A - AAC-kodiertes Audioformat mit guter Qualität">M4A</option>
                                    <option value="flac" {% if config.get('processors.audio.export_format') == 'flac' %}selected{% endif %}
                                            title="FLAC - Verlustfreie Audiokompression">FLAC</option>
                                </select>
                                <div class="form-text">Wählen Sie das Format für die Audioausgabe nach der Verarbeitung.</div>
                            </div>
                        </div>
                    </div>

                    <!-- API Settings -->
                    <h5 class="card-title mb-4">API Settings</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="openaiApiKey" class="form-label">OpenAI API Key</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="openaiApiKey" name="openai_api_key" value="{{ config.openai_api_key }}">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('openaiApiKey')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
{% endblock %}

{% block extra_scripts %}
<script>
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
}

function convertFormToConfig(formData) {
    const config = {
        server: {},
        processors: {
            youtube: {
                ydl_opts: {}
            },
            audio: {}
        }
    };

    // Konvertiere Dateigrößen von MB zu Bytes
    const mbToBytes = (mb) => mb * 1048576;
    // Konvertiere Minuten zu Sekunden
    const minToSec = (min) => min * 60;

    for (let [key, value] of formData.entries()) {
        const parts = key.split('.');
        let current = config;
        
        // Spezielle Behandlung für Zahlen und Booleans
        if (key.includes('max_file_size')) {
            value = mbToBytes(Number(value));
        } else if (key.includes('max_duration') || key.includes('segment_duration')) {
            value = minToSec(Number(value));
        } else if (key.includes('debug')) {
            value = value === 'on';
        }

        // Baue verschachtelte Struktur auf
        for (let i = 0; i < parts.length - 1; i++) {
            if (!current[parts[i]]) {
                current[parts[i]] = {};
            }
            current = current[parts[i]];
        }
        
        current[parts[parts.length - 1]] = value;
    }

    return config;
}

document.getElementById('configForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const config = convertFormToConfig(formData);
    
    try {
        const response = await fetch('/api/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(config)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        // Show success message
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show mt-3';
        alert.innerHTML = `
            Configuration saved successfully!
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        this.insertAdjacentElement('beforebegin', alert);

        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            alert.remove();
        }, 3000);

    } catch (error) {
        console.error('Failed to save configuration:', error);
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show mt-3';
        alert.innerHTML = `
            Failed to save configuration: ${error.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        this.insertAdjacentElement('beforebegin', alert);
    }
});
</script>
{% endblock %} 
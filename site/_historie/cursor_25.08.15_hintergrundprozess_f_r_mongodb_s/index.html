
<!doctype html>
<html lang="de" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://example.local/_historie/cursor_25.08.15_hintergrundprozess_f_r_mongodb_s/">
      
      
      
      
      <link rel="icon" href="../../assets/images/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>Hintergrundprozess für MongoDB-Sessions - Common Secretary Services</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/print-site.css">
    
      <link rel="stylesheet" href="../../css/print-site-material.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hintergrundprozess-fur-mongodb-sessions" class="md-skip">
          Zum Inhalt
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Kopfzeile">
    <a href="../.." title="Common Secretary Services" class="md-header__button md-logo" aria-label="Common Secretary Services" data-md-component="logo">
      
  <img src="../../assets/images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Common Secretary Services
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Hintergrundprozess für MongoDB-Sessions
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Suche" placeholder="Suche" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Suche">
        
        <button type="reset" class="md-search__icon md-icon" title="Zurücksetzen" aria-label="Zurücksetzen" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Suche wird initialisiert
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://example.local/repo" title="Zum Repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Example
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Common Secretary Services" class="md-nav__button md-logo" aria-label="Common Secretary Services" data-md-component="logo">
      
  <img src="../../assets/images/logo.png" alt="logo">

    </a>
    Common Secretary Services
  </label>
  
    <div class="md-nav__source">
      <a href="https://example.local/repo" title="Zum Repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Example
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    « Zur Anwendung
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/getting-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/getting-started/development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Development
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    UI
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            UI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/ui/dashboard/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dashboard
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    How‑Tos
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            How‑Tos
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/how-tos/session-archive/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Session‑Archive
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Explanations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Explanations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architektur
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Architektur
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explanations/architecture/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Überblick
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explanations/architecture/details/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Details
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Async Events
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Async Events
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explanations/async-events/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Überblick
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explanations/async-events/generic-worker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Generischer Worker
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explanations/async-events/secretary-job-worker-concept/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Secretary Job Worker – Konzept
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explanations/async-events/how-to-n8n/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    n8n
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explanations/caching/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Caching
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explanations/templates/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Templates
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explanations/types/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Typen & Dataclasses
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explanations/metaprocessor/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metaprocessor
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explanations/metadata/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metadaten
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explanations/llm/optimization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLM‑Optimierung
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Processors
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Processors
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../processors/audio/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Audio
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../processors/video/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Video
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    PDF
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            PDF
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../processors/pdf/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Überblick
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../processors/pdf/ocr-refactoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OCR-Refactoring
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../processors/pdf/endpoints/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDF/ImageOCR Details
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../processors/image-ocr/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Image-OCR
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../processors/transformer/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transformer
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../processors/session/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Session
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../processors/event-job/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event-Job
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../processors/story/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Story
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../processors/track/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Track
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Überblick
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/openapi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenAPI / Swagger
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Ops
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Ops
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deployment
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sicherheit
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Inhaltsverzeichnis">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Inhaltsverzeichnis
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#was-lauft-im-hintergrund" class="md-nav__link">
    <span class="md-ellipsis">
      Was läuft im Hintergrund?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wo-wird-er-gestartet" class="md-nav__link">
    <span class="md-ellipsis">
      Wo wird er gestartet?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wie-uberwacht-er-mongodb" class="md-nav__link">
    <span class="md-ellipsis">
      Wie überwacht er MongoDB?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wie-verarbeitet-ein-worker-eine-session" class="md-nav__link">
    <span class="md-ellipsis">
      Wie verarbeitet ein Worker eine Session?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#konfiguration" class="md-nav__link">
    <span class="md-ellipsis">
      Konfiguration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nebenlaufigkeit-und-robustheit" class="md-nav__link">
    <span class="md-ellipsis">
      Nebenläufigkeit und Robustheit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#minimaler-test-manuell" class="md-nav__link">
    <span class="md-ellipsis">
      Minimaler Test (manuell)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inkrementeller-migrationsplan" class="md-nav__link">
    <span class="md-ellipsis">
      Inkrementeller Migrationsplan
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risiken-und-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Risiken und Tests
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#empfehlung" class="md-nav__link">
    <span class="md-ellipsis">
      Empfehlung
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Empfehlung">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pdf-handler-beispiel" class="md-nav__link">
    <span class="md-ellipsis">
      PDF-Handler (Beispiel)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inkrementelles-vorgehen-konkret" class="md-nav__link">
    <span class="md-ellipsis">
      Inkrementelles Vorgehen (konkret)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tests-gezielt" class="md-nav__link">
    <span class="md-ellipsis">
      Tests (gezielt)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#beispiel-pdf-job-enqueuen" class="md-nav__link">
    <span class="md-ellipsis">
      Beispiel: PDF-Job enqueuen
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-inkrementell" class="md-nav__link">
    <span class="md-ellipsis">
      Migration (inkrementell)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verweise" class="md-nav__link">
    <span class="md-ellipsis">
      Verweise
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="hintergrundprozess-fur-mongodb-sessions">Hintergrundprozess für MongoDB-Sessions<a class="headerlink" href="#hintergrundprozess-fur-mongodb-sessions" title="Permanent link">&para;</a></h1>
<p><em>Exported on 8/15/2025 at 10:00:42 GMT+2 from Cursor (1.4.5)</em></p>
<hr />
<p><strong>User</strong></p>
<p>ich hier einen Hintergrundprozess, der ständig in einem MongoDB auftauchende Sessions überwacht und verarbeitet. können wir das genau erklären.</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich scanne kurz den Code nach dem Hintergrundprozess, der MongoDB-Sessions überwacht und verarbeitet, um den Ablauf präzise zu erklären. Ich schaue parallel nach Manager/Worker-Komponenten, eventuellen Change Streams und Locking-/Polling-Logik.</p>
<p>Ich habe die relevanten Stellen identifiziert und lese nun die zentralen Dateien parallel, um den Ablauf präzise zu erklären: den Worker-Manager, das Mongo-Repository, die Startlogik in der Dashboard-App und den Session-Processor-Einstieg für Batch/Jobs.</p>
<p>Kurzes Update: Ich habe die relevanten Module gelesen: <code>src/core/mongodb/worker_manager.py</code>, <code>src/core/mongodb/repository.py</code>, <code>src/dashboard/app.py</code>, <code>src/core/models/job_models.py</code> und die Batch-Erzeugung in <code>src/processors/session_processor.py</code>. Unten erkläre ich den Ablauf präzise inkl. Konfiguration, Polling, Statuswechseln und Nebenläufigkeit.</p>
<h3 id="was-lauft-im-hintergrund">Was läuft im Hintergrund?<a class="headerlink" href="#was-lauft-im-hintergrund" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Hintergrundmanager</strong>: <code>SessionWorkerManager</code> läuft als eigener Überwachungs-Thread und pollt periodisch MongoDB nach neuen Jobs (Status <code>pending</code>). Keine Change Streams; es ist Polling.</li>
<li><strong>Start/Stop</strong>: Der Manager wird beim ersten HTTP-Request im Flask-App-Prozess gestartet und beim Beenden gestoppt.</li>
<li><strong>Job-Verarbeitung</strong>: Jeder Job wird in einem eigenen Thread verarbeitet; darin läuft eine <code>asyncio</code>-Event-Loop für die eigentliche Session-Verarbeitung.</li>
</ul>
<h3 id="wo-wird-er-gestartet">Wo wird er gestartet?<a class="headerlink" href="#wo-wird-er-gestartet" title="Permanent link">&para;</a></h3>
<p>```71:99:src/dashboard/app.py
@app.before_request
def before_request() -&gt; None:
    """Wird vor jedem Request ausgeführt"""
    global _first_request, _worker_manager, _cache_setup_done</p>
<pre><code>if _first_request and not os.environ.get('WERKZEUG_RUN_MAIN'):
    ...
    # Worker-Manager starten
    try:
        _worker_manager = get_worker_manager()
        if _worker_manager is not None:
            _worker_manager.start()
            logger.info("Worker-Manager gestartet")
        else:
            logger.info("Worker-Manager ist deaktiviert (event_worker.active=False in config.yaml)")
    except Exception as e:
        logger.error(f"Fehler beim Starten des Worker-Managers: {str(e)}")

    _first_request = False
</code></pre>
<p><code>``

- Aktivierung über</code>config/config.yaml<code>:
  -</code>session_worker.active: true<code>-</code>session_worker.max_concurrent<code>(Anzahl paralleler Worker-Threads)
  -</code>session_worker.poll_interval_sec<code>(Polling-Intervall in Sekunden)
- Voraussetzung:</code>MONGODB_URI` muss gesetzt sein (wird geprüft).
</p>
<h3 id="wie-uberwacht-er-mongodb">Wie überwacht er MongoDB?<a class="headerlink" href="#wie-uberwacht-er-mongodb" title="Permanent link">&para;</a></h3>
<p><code>76:106:src/core/mongodb/worker_manager.py
def _monitor_jobs(self) -&gt; None:
    """Überwacht Jobs und startet neue Worker bei Bedarf."""
    logger.info("Job-Monitor gestartet")

    while not self.stop_flag:
        try:
            # Entferne beendete Worker
            self._cleanup_workers()

            # Prüfe, ob neue Worker gestartet werden können
            if len(self.running_workers) &lt; self.max_concurrent_workers:
                # Hole ausstehende Jobs
                pending_jobs = self.job_repo.get_jobs(status=JobStatus.PENDING)

                for job in pending_jobs:
                    if len(self.running_workers) &gt;= self.max_concurrent_workers:
                        break

                    if job.job_id not in self.running_workers:
                        self._start_worker(job)

        except Exception as e:
            logger.error(f"Fehler im Job-Monitor: {str(e)}", exc_info=True)

        # Warte vor dem nächsten Durchlauf
        for _ in range(self.poll_interval_sec):
            if self.stop_flag:
                break
            time.sleep(1)</code></p>
<ul>
<li>Er pollt <code>event_jobs</code> (Collection-Name) nach <code>pending</code> Jobs.</li>
<li>Startet pro Job einen Thread (bis <code>max_concurrent_workers</code> erreicht ist).</li>
</ul>
<h3 id="wie-verarbeitet-ein-worker-eine-session">Wie verarbeitet ein Worker eine Session?<a class="headerlink" href="#wie-verarbeitet-ein-worker-eine-session" title="Permanent link">&para;</a></h3>
<p>```162:348:src/core/mongodb/worker_manager.py
async def _process_session(self, job: Job) -&gt; None:
    ...
    processor = SessionProcessor(
        resource_calculator=self.resource_calculator,
        process_id=job_id
    )
    self.job_repo.update_job_status(job_id=job_id, status=JobStatus.PROCESSING, ...)
    params = getattr(job, 'parameters', None)
    ...
    result = await processor.process_session(
        event=event, session=session, url=url, filename=filename,
        track=track, day=day, starttime=starttime, endtime=endtime,
        speakers=speakers, video_url=video_url, attachments_url=attachments_url,
        source_language=source_language, target_language=target_language,
        use_cache=use_cache, create_archive=create_archive
    )
    ...
    self.job_repo.update_job_status(job_id=job_id, status=JobStatus.COMPLETED, ..., results=JobResults(...))
    self.job_repo.add_log_entry(job_id=job_id, level="info", message="Session-Verarbeitung erfolgreich abgeschlossen ...")
<div class="highlight"><pre><span></span><code>- Parameter werden sicher aus `job.parameters` extrahiert.
- Statuswechsel: `pending` → `processing` → `completed` oder bei Fehler `failed` (inkl. `error`-Details).
- Nach Abschluss: Ergebnisse (Markdown, Transkripte, Assets, ggf. ZIP) werden in `results` gespeichert. Batch-Fortschritt wird nachgeführt.

### Datenmodell und Repositories
- Collections: `event_jobs` (Jobs), `event_batches` (Batches), Indizes sind angelegt.
```64:1013:src/core/mongodb/repository.py
def create_job(...): ... self.jobs.insert_one(job_dict) ...
def update_job_status(...): ... self.jobs.update_one({&quot;job_id&quot;: job_id}, {&quot;$set&quot;: update_dict})
def add_log_entry(...): ... &quot;$push&quot;: {&quot;logs&quot;: log_entry.to_dict()}
def get_jobs(...): ... self.jobs.find(filter_dict)...
def create_batch(...): ... self.batches.insert_one(batch_dict)
def update_batch_progress(...): ... counts completed/failed und setzt Status
def reset_stalled_jobs(...): ... setzt lange PROCESSING-Jobs auf FAILED (Timeout)
</code></pre></div></p>
<ul>
<li>
<p>Dataclasses für Status/Struktur:
```12:35:src/core/models/job_models.py
class JobStatus(str, Enum): PENDING="pending" PROCESSING="processing" COMPLETED="completed" FAILED="failed"
...
@dataclass class Job: job_id, status, parameters, results, error, progress, batch_id, ...
@dataclass class Batch: total_jobs, status, ... completed_jobs, failed_jobs, pending_jobs, processing_jobs
<div class="highlight"><pre><span></span><code>### Wie kommen Sessions in die Queue?
- Über die asynchrone Batch-API im `SessionProcessor` werden Batches und Jobs in Mongo angelegt.
```1316:1385:src/processors/session_processor.py
async def _process_many_sessions_async_task(self, input_data: AsyncBatchSessionInput) -&gt; None:
    job_repo = get_job_repository()
    batch_id = job_repo.create_batch({...})
    for session in input_data.sessions:
        session_data = self._validate_session_data(session)
        job_id = job_repo.create_job({&quot;batch_id&quot;: batch_id, &quot;parameters&quot;: session_data, &quot;webhook&quot;: ...})
</code></pre></div></p>
</li>
<li>
<p>Der Hintergrund-Worker greift diese <code>pending</code> Jobs auf und verarbeitet sie.</p>
</li>
</ul>
<h3 id="konfiguration">Konfiguration<a class="headerlink" href="#konfiguration" title="Permanent link">&para;</a></h3>
<ul>
<li><code>config/config.yaml</code>:</li>
<li><code>session_worker.active: true</code></li>
<li><code>session_worker.max_concurrent: 3</code></li>
<li><code>session_worker.poll_interval_sec: 5</code></li>
<li><code>mongodb.uri: ${MONGODB_URI}</code> (muss gesetzt sein)</li>
</ul>
<h3 id="nebenlaufigkeit-und-robustheit">Nebenläufigkeit und Robustheit<a class="headerlink" href="#nebenlaufigkeit-und-robustheit" title="Permanent link">&para;</a></h3>
<ul>
<li>Nebenläufigkeit: Threads pro Job; intern <code>asyncio</code> für I/O-lastige Schritte.</li>
<li>Cleanup: Beendete Threads werden entfernt; fehlgeschlagene Jobs bekommen Fehlerdetails.</li>
<li>Watchdog: <code>reset_stalled_jobs()</code> kann hängen gebliebene <code>processing</code>-Jobs auf <code>failed</code> setzen (Timeout).</li>
</ul>
<h3 id="minimaler-test-manuell">Minimaler Test (manuell)<a class="headerlink" href="#minimaler-test-manuell" title="Permanent link">&para;</a></h3>
<ul>
<li>Server starten: in venv, dann <code>python src/main.py</code> (oder wie in deinem Setup).</li>
<li>Sicherstellen, dass <code>MONGODB_URI</code> korrekt gesetzt ist.</li>
<li>Über API/Route, die <code>process_sessions_async</code> triggert (oder notfalls direkt <code>SessionJobRepository.create_job(...)</code>) einen <code>pending</code> Job anlegen.</li>
<li>Im Log sehen, dass der Worker startet und den Job auf <code>processing</code> und dann <code>completed/failed</code> setzt. In MongoDB <code>event_jobs</code> prüfen.</li>
</ul>
<p>Kurzfazit:
- Der Hintergrundprozess ist der <code>SessionWorkerManager</code>. Er pollt im Intervall <code>poll_interval_sec</code> die Collection <code>event_jobs</code> nach <code>pending</code> Jobs und verarbeitet diese parallel bis <code>max_concurrent_workers</code>. Status, Fortschritt, Logs und Batch-Fortschritt werden konsistent in MongoDB gepflegt. Change Streams werden nicht verwendet (reines Polling).</p>
<ul>
<li>Änderungen: keine</li>
<li>Wirkung: Detaillierte Erklärung des Hintergrundprozess-Designs und seiner Konfiguration/Statusflüsse.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">before_request</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wird vor jedem Request ausgeführt&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_first_request</span><span class="p">,</span> <span class="n">_worker_manager</span><span class="p">,</span> <span class="n">_cache_setup_done</span>

    <span class="k">if</span> <span class="n">_first_request</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;WERKZEUG_RUN_MAIN&#39;</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="c1"># Worker-Manager starten</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_worker_manager</span> <span class="o">=</span> <span class="n">get_worker_manager</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">_worker_manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_worker_manager</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Worker-Manager gestartet&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Worker-Manager ist deaktiviert (event_worker.active=False in config.yaml)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fehler beim Starten des Worker-Managers: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">_first_request</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_monitor_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Überwacht Jobs und startet neue Worker bei Bedarf.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Job-Monitor gestartet&quot;</span><span class="p">)</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_flag</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Entferne beendete Worker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_workers</span><span class="p">()</span>

            <span class="c1"># Prüfe, ob neue Worker gestartet werden können</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_workers</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_concurrent_workers</span><span class="p">:</span>
                <span class="c1"># Hole ausstehende Jobs</span>
                <span class="n">pending_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_repo</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">JobStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">pending_jobs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_workers</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_concurrent_workers</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_workers</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_start_worker</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fehler im Job-Monitor: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Warte vor dem nächsten Durchlauf</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poll_interval_sec</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_flag</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">SessionProcessor</span><span class="p">(</span>
        <span class="n">resource_calculator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_calculator</span><span class="p">,</span>
        <span class="n">process_id</span><span class="o">=</span><span class="n">job_id</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">job_repo</span><span class="o">.</span><span class="n">update_job_status</span><span class="p">(</span><span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">JobStatus</span><span class="o">.</span><span class="n">PROCESSING</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_session</span><span class="p">(</span>
        <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="n">track</span><span class="o">=</span><span class="n">track</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">day</span><span class="p">,</span> <span class="n">starttime</span><span class="o">=</span><span class="n">starttime</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="n">endtime</span><span class="p">,</span>
        <span class="n">speakers</span><span class="o">=</span><span class="n">speakers</span><span class="p">,</span> <span class="n">video_url</span><span class="o">=</span><span class="n">video_url</span><span class="p">,</span> <span class="n">attachments_url</span><span class="o">=</span><span class="n">attachments_url</span><span class="p">,</span>
        <span class="n">source_language</span><span class="o">=</span><span class="n">source_language</span><span class="p">,</span> <span class="n">target_language</span><span class="o">=</span><span class="n">target_language</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">,</span> <span class="n">create_archive</span><span class="o">=</span><span class="n">create_archive</span>
    <span class="p">)</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">job_repo</span><span class="o">.</span><span class="n">update_job_status</span><span class="p">(</span><span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">JobStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">JobResults</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">job_repo</span><span class="o">.</span><span class="n">add_log_entry</span><span class="p">(</span><span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Session-Verarbeitung erfolgreich abgeschlossen ...&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_job</span><span class="p">(</span><span class="o">...</span><span class="p">):</span> <span class="o">...</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">job_dict</span><span class="p">)</span> <span class="o">...</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_job_status</span><span class="p">(</span><span class="o">...</span><span class="p">):</span> <span class="o">...</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="n">update_dict</span><span class="p">})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_log_entry</span><span class="p">(</span><span class="o">...</span><span class="p">):</span> <span class="o">...</span> <span class="s2">&quot;$push&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;logs&quot;</span><span class="p">:</span> <span class="n">log_entry</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()}</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_jobs</span><span class="p">(</span><span class="o">...</span><span class="p">):</span> <span class="o">...</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">)</span><span class="o">...</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_batch</span><span class="p">(</span><span class="o">...</span><span class="p">):</span> <span class="o">...</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_batch_progress</span><span class="p">(</span><span class="o">...</span><span class="p">):</span> <span class="o">...</span> <span class="n">counts</span> <span class="n">completed</span><span class="o">/</span><span class="n">failed</span> <span class="n">und</span> <span class="n">setzt</span> <span class="n">Status</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reset_stalled_jobs</span><span class="p">(</span><span class="o">...</span><span class="p">):</span> <span class="o">...</span> <span class="n">setzt</span> <span class="n">lange</span> <span class="n">PROCESSING</span><span class="o">-</span><span class="n">Jobs</span> <span class="n">auf</span> <span class="n">FAILED</span> <span class="p">(</span><span class="n">Timeout</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">JobStatus</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span> <span class="n">PENDING</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span> <span class="n">PROCESSING</span><span class="o">=</span><span class="s2">&quot;processing&quot;</span> <span class="n">COMPLETED</span><span class="o">=</span><span class="s2">&quot;completed&quot;</span> <span class="n">FAILED</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span>
<span class="o">...</span>
<span class="nd">@dataclass</span> <span class="k">class</span><span class="w"> </span><span class="nc">Job</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">,</span> <span class="o">...</span>
<span class="nd">@dataclass</span> <span class="k">class</span><span class="w"> </span><span class="nc">Batch</span><span class="p">:</span> <span class="n">total_jobs</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="o">...</span> <span class="n">completed_jobs</span><span class="p">,</span> <span class="n">failed_jobs</span><span class="p">,</span> <span class="n">pending_jobs</span><span class="p">,</span> <span class="n">processing_jobs</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_many_sessions_async_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="n">AsyncBatchSessionInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">job_repo</span> <span class="o">=</span> <span class="n">get_job_repository</span><span class="p">()</span>
    <span class="n">batch_id</span> <span class="o">=</span> <span class="n">job_repo</span><span class="o">.</span><span class="n">create_batch</span><span class="p">({</span><span class="o">...</span><span class="p">})</span>
    <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">input_data</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
        <span class="n">session_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_session_data</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_repo</span><span class="o">.</span><span class="n">create_job</span><span class="p">({</span><span class="s2">&quot;batch_id&quot;</span><span class="p">:</span> <span class="n">batch_id</span><span class="p">,</span> <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">session_data</span><span class="p">,</span> <span class="s2">&quot;webhook&quot;</span><span class="p">:</span> <span class="o">...</span><span class="p">})</span>
</code></pre></div>
<hr />
<p><strong>User</strong></p>
<p>Jetzt sollte dieser Prozess aber nicht nur Events überwachen und ausführen, sondern ich möchte auch PDF-Dokumente transformieren, alle Seiten transkribieren und viele Dokumente als Batch verarbeiten. Macht es Sinn, da jetzt einen parallelen Batch-Prozess aufzubauen? Oder können wir diesen SessionWorkerManager umbauen, dass er generischer funktioniert und andere Jobs übernimmt? Wie könnte man das abstrahieren? Am Ende sollte er jeden Prozessor, jede Funktion, Dokumentenverarbeitende Funktion aus beliebigen Prozessoren entgegennehmen und diese asynchron abarbeiten.</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich prüfe schnell die vorhandenen Prozessor-Schnittstellen (PDF, Audio etc.), um eine realistische Abstraktionsschicht/Registry vorzuschlagen, die <code>job_type</code> → Handler mappt. Ich lese parallel die relevanten Dateien.</p>
<p>Ich erstelle eine kurze Architektur-Analyse als Markdown unter <code>docs/_analysis/generic_worker.md</code> mit Varianten, Abstraktion und einem inkrementellen Migrationsplan.</p>
<div class="highlight"><pre><span></span><code><span class="gu">## Ziel</span>

Ein generischer Hintergrund-Worker soll nicht nur Sessions/Events, sondern auch PDF-, Audio-, Bild-/OCR-, Video- und Transformationsaufgaben asynchron verarbeiten. Ein einziges, erweiterbares System soll beliebige Prozessoren bedienen (Batch-fähig), Status/Progress/Errors konsistent tracken und Webhooks optional unterstützen.

<span class="gu">## Ist-Zustand (kurz)</span>

<span class="k">-</span><span class="w"> </span><span class="sb">`SessionWorkerManager`</span> pollt <span class="sb">`event_jobs`</span> (MongoDB) zyklisch nach <span class="sb">`pending`</span> und startet Threads, die pro Job <span class="sb">`SessionProcessor.process_session(...)`</span> ausführen.
<span class="k">-</span><span class="w"> </span>Statuswechsel: <span class="sb">`pending → processing → completed/failed`</span>, Logs und Batch-Fortschritt via <span class="sb">`SessionJobRepository`</span>.
<span class="k">-</span><span class="w"> </span><span class="sb">`Job`</span> Dataclass hat bereits <span class="sb">`job_type`</span> (String), aber <span class="sb">`parameters`</span> ist auf session-spezifische Felder limitiert (<span class="sb">`JobParameters`</span>).

<span class="gu">## Anforderungen an die Generalisierung</span>

<span class="k">-</span><span class="w"> </span>Einheitlicher Job-Lebenszyklus für verschiedene Typen (<span class="sb">`session`</span>, <span class="sb">`pdf`</span>, <span class="sb">`audio`</span>, ...).
<span class="k">-</span><span class="w"> </span>Dispatching: <span class="sb">`job_type → Handler/Processor`</span> mit klarer Signatur und Fehler-/Progress-Reporting.
<span class="k">-</span><span class="w"> </span>Batch-Verarbeitung über dieselben Batch-Modelle (minimale Änderungen), per-Type Einstellungen für Parallelität sinnvoll.
<span class="k">-</span><span class="w"> </span>Rückwärtskompatibilität: Bestehende Session-Jobs funktionieren weiter.

<span class="gu">## Varianten</span>

1) Separater Prozess/Manager je Domäne (z. B. <span class="sb">`DocumentWorkerManager`</span> für PDFs)
<span class="k">-</span><span class="w"> </span>Vorteile: Isolation, per-Domäne eigene Skalierung/Abhängigkeiten; geringes Risiko für Regressionen.
<span class="k">-</span><span class="w"> </span>Nachteile: Code-Duplizierung (Polling, Status, Logging), mehr Betriebsaufwand, mehrere Queues/Collections.

2) Ein generischer Worker mit Registry/Dispatch (empfohlen)
<span class="k">-</span><span class="w"> </span>Idee: Eine <span class="sb">`ProcessorRegistry`</span> mappt <span class="sb">`job_type`</span> → <span class="sb">`JobHandler`</span>. Der bestehende Manager pollt weiterhin, nimmt aber alle <span class="sb">`pending`</span> Jobs und ruft den passenden Handler auf.
<span class="k">-</span><span class="w"> </span>Vorteile: Einfache Erweiterbarkeit, einheitliches Monitoring/Batching, minimale Infrastrukturänderung.
<span class="k">-</span><span class="w"> </span>Nachteile: Kleiner Refactor nötig (Parameter/Job-Modell), per-Type QoS muss bedacht werden.

3) Supervisor + per-Type Sub-Worker (hybrid)
<span class="k">-</span><span class="w"> </span>Ein Supervisor spawnt Sub-Worker pro Typ mit eigener Parallelität (Work-Stealing möglich).
<span class="k">-</span><span class="w"> </span>Vorteile: Gute Kontrolle/Isolation, trotzdem einheitliche Steuerung.
<span class="k">-</span><span class="w"> </span>Nachteile: Komplexer als (2), eher für hohe Last nötig.

<span class="gu">## Empfohlene Abstraktion (Variante 2)</span>

1) Job-Modell erweitern (minimal-invasiv):
<span class="k">-</span><span class="w"> </span><span class="sb">`JobParameters`</span> um <span class="sb">`extra: Dict[str, Any]`</span> erweitern, das unbekannte Felder aus <span class="sb">`parameters`</span> aufnimmt (in <span class="sb">`from_dict`</span>) und in <span class="sb">`to_dict`</span> wieder ausgibt. So können PDF-spezifische Parameter (z. B. <span class="sb">`file_path`</span>, <span class="sb">`extraction_method`</span>, <span class="sb">`include_images`</span>, <span class="sb">`template`</span>, <span class="sb">`context`</span>) ohne Schema-Bruch transportiert werden.
<span class="k">-</span><span class="w"> </span>Optional später: per-`job_type`-spezifische Parameter-Dataclasses.

2) Processor-Registry einführen:
<span class="k">-</span><span class="w"> </span>Ort: <span class="sb">`src/core/processing/registry.py`</span> (neu).
<span class="k">-</span><span class="w"> </span>API: <span class="sb">`register(job_type: str, handler: Callable[[Job, SessionJobRepository, ResourceCalculator], Awaitable[None]]))`</span> und <span class="sb">`get(job_type) → handler`</span>.
<span class="k">-</span><span class="w"> </span>Handlers implementieren Status-/Progress-Updates per <span class="sb">`SessionJobRepository`</span> wie heute in <span class="sb">`SessionWorkerManager._process_session`</span>.

3) <span class="sb">`SessionWorkerManager`</span> → <span class="sb">`GenericWorkerManager`</span> umbauen (schrittweise):
<span class="k">-</span><span class="w"> </span>Behalte Polling, Thread-Start und Cleanup.
<span class="k">-</span><span class="w"> </span>Im Worker-Thread: Statt fest <span class="sb">`SessionProcessor`</span> zu nutzen, <span class="sb">`job.job_type`</span> lesen, Handler aus Registry holen, aufrufen.
<span class="k">-</span><span class="w"> </span>Fallback: unbekannter <span class="sb">`job_type`</span> → <span class="sb">`FAILED`</span> mit Fehlercode <span class="sb">`UNKNOWN_JOB_TYPE`</span>.
<span class="k">-</span><span class="w"> </span>Optional: per-Type Parallelitäts-Limits (z. B. <span class="sb">`max_concurrent_per_type`</span> in Config).

4) PDF-Handler (Beispiel):
<span class="k">-</span><span class="w"> </span>Liest <span class="sb">`file_path`</span>, <span class="sb">`extraction_method`</span>, <span class="sb">`template`</span>, <span class="sb">`context`</span>, <span class="sb">`include_images`</span> aus <span class="sb">`job.parameters.extra`</span> (bzw. generisch <span class="sb">`parameters`</span>).
<span class="k">-</span><span class="w"> </span>Nutzt <span class="sb">`PDFProcessor.process(...)`</span> und schreibt Ergebnis nach <span class="sb">`results`</span>.

5) Batchs beibehalten:
<span class="k">-</span><span class="w"> </span>Batches funktionieren unverändert; optional <span class="sb">`batch.job_type`</span> setzen, aber nicht zwingend.

<span class="gu">## Pseudocode-Entwurf (vereinfachter Kern)</span>

```python
<span class="gh"># registry.py</span>
REGISTRY: dict[str, Callable[..., Awaitable[None]]] = {}

def register(job_type: str, handler: Callable[[Job, SessionJobRepository, ResourceCalculator], Awaitable[None]]):
    REGISTRY[job_type] = handler

def get_handler(job_type: str):
    return REGISTRY.get(job_type)

<span class="gh"># worker_manager (Worker-Thread)</span>
async def <span class="ge">_process_</span>job(self, job: Job):
    handler = registry.get_handler(job.job_type or &quot;session&quot;)
    if not handler:
        self.job_repo.update_job_status(job.job_id, JobStatus.FAILED, error=JobError(code=&quot;UNKNOWN_JOB_TYPE&quot;, message=f&quot;{job.job_type}&quot;))
        return
    await handler(job, self.job_repo, self.resource_calculator)

<span class="gh"># registrierung</span>
register(&quot;session&quot;, handle_session_job)
register(&quot;pdf&quot;, handle_pdf_job)
</code></pre></div>
<h2 id="inkrementeller-migrationsplan">Inkrementeller Migrationsplan<a class="headerlink" href="#inkrementeller-migrationsplan" title="Permanent link">&para;</a></h2>
<p>1) Minimal-Refactor (keine API-Änderungen):
- Registry hinzufügen, <code>SessionWorkerManager</code> intern auf <code>job_type</code>-Dispatch umbauen.
- <code>session</code>-Handler implementieren und als Default registrieren.</p>
<p>2) PDF-Unterstützung:
- <code>pdf</code>-Handler implementieren (ruft <code>PDFProcessor.process(...)</code>).
- Endpunkt/Use-Case zum Enqueue von PDF-Jobs oder Batch (analog <code>process_sessions_async</code>).</p>
<p>3) Parameter-Generalität:
- <code>JobParameters</code> um <code>extra: Dict[str, Any]</code> erweitern und <code>from_dict</code> so anpassen, dass unbekannte Keys dort landen.
- Später optional per-Type Parameter-Dataclasses + Validierung.</p>
<p>4) Konfiguration/Skalierung:
- <code>session_worker</code> → <code>generic_worker</code> benennen (optional) und <code>max_concurrent_per_type</code> unterstützen.
- Optional: Webhooks pro Job vereinheitlichen (Dataclass im Job-Modell aufnehmen).</p>
<h2 id="risiken-und-tests">Risiken und Tests<a class="headerlink" href="#risiken-und-tests" title="Permanent link">&para;</a></h2>
<ul>
<li>Risiko: Verlust unbekannter Parameter im aktuellen <code>JobParameters</code>. → Mit <code>extra</code> abfangen.</li>
<li>Tests: </li>
<li>Enqueue + Verarbeitung <code>session</code> und <code>pdf</code> Jobs in einem Batch; </li>
<li>Parallelitätsgrenzen; </li>
<li>Fehlerpfade (unbekannter <code>job_type</code>, fehlende Parameter), </li>
<li>Batch-Fortschritt und Status-Updates.</li>
</ul>
<h2 id="empfehlung">Empfehlung<a class="headerlink" href="#empfehlung" title="Permanent link">&para;</a></h2>
<p>Variante (2) mit Registry/Dispatch zuerst implementieren. Sie ist die kleinste, saubere Generalisierung und lässt sich später zu (3) ausbauen, falls per-Type Supervisor nötig wird.</p>
<div class="highlight"><pre><span></span><code>Kurzes Update: Ich habe eine prägnante Architektur-Analyse und einen Migrationsvorschlag in `docs/_analysis/generic_worker.md` abgelegt. Unten die Kernaussagen für die Entscheidung.

### Überlegungen
- Ein separater Batch-Prozess nur für PDFs verdoppelt Polling/Status/Batch-Logik und erhöht den Betriebsaufwand.
- Sinnvoller ist ein generischer Worker: ein Dispatcher verarbeitet Jobs verschiedener Typen (session, pdf, audio, …) über eine Registry. So bleibt alles konsistent (Status, Progress, Batch) und erweiterbar.
- Minimal-invasive Umsetzung ist möglich: keine neuen Queues, kein Bruch existierender Session-Jobs.

### Empfohlene Abstraktion
- **Registry**: `job_type -&gt; async handler(job, repo, resource_calculator)`.  
- **GenericWorkerManager**: baut den bestehenden `SessionWorkerManager` um, ruft anhand `job.job_type` den Handler auf. Fallback: unbekannter Typ → `FAILED`.
- **Parameter-Generalisierung**: kurzfristig `JobParameters` um `extra: Dict[str, Any]` ergänzen (unbekannte Felder landen dort). Später optional per-`job_type`-spezifische Dataclasses.
- **Batch bleibt**: gleiche `event_jobs`/`event_batches`, nur `job_type` unterschiedlich.

### Skizze (Handler/Registry)
```python
# src/core/processing/registry.py
REGISTRY: dict[str, Callable[[Job, SessionJobRepository, ResourceCalculator], Awaitable[None]]] = {}

def register(job_type: str, handler: Callable[..., Awaitable[None]]) -&gt; None:
    REGISTRY[job_type] = handler

def get_handler(job_type: str):
    return REGISTRY.get(job_type)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># im Worker-Thread (ehem. _process_session)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get_handler</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">or</span> <span class="s2">&quot;session&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">handler</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_repo</span><span class="o">.</span><span class="n">update_job_status</span><span class="p">(</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">JobStatus</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="n">JobError</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;UNKNOWN_JOB_TYPE&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_type</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">return</span>
    <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_repo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_calculator</span><span class="p">)</span>
</code></pre></div>
<h3 id="pdf-handler-beispiel">PDF-Handler (Beispiel)<a class="headerlink" href="#pdf-handler-beispiel" title="Permanent link">&para;</a></h3>
<ul>
<li>Liest <code>file_path</code>, <code>extraction_method</code>, <code>include_images</code>, <code>template</code>, <code>context</code> aus <code>job.parameters.extra</code>.</li>
<li>Ruft <code>PDFProcessor.process(...)</code>, schreibt <code>results</code> und <code>progress</code>, setzt Status.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># registrar</span>
<span class="n">register</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="n">handle_session_job</span><span class="p">)</span>
<span class="n">register</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">handle_pdf_job</span><span class="p">)</span>
</code></pre></div>
<h3 id="inkrementelles-vorgehen-konkret">Inkrementelles Vorgehen (konkret)<a class="headerlink" href="#inkrementelles-vorgehen-konkret" title="Permanent link">&para;</a></h3>
<ul>
<li>Neue Datei: <code>src/core/processing/registry.py</code>.</li>
<li><code>src/core/mongodb/worker_manager.py</code>: Dispatch auf Registry statt hart <code>SessionProcessor</code>.</li>
<li><code>src/core/models/job_models.py</code>: <code>JobParameters</code> minimal um <code>extra: Dict[str, Any] = field(default_factory=dict)</code> erweitern; <code>from_dict</code> unbekannte Keys dort ablegen.</li>
<li>PDF-Unterstützung: <code>handle_pdf_job</code> implementieren; Enqueue-Route analog Session-Batch hinzufügen oder bestehenden PDF-Endpunkt um asynchronen Mode ergänzen.</li>
</ul>
<h3 id="tests-gezielt">Tests (gezielt)<a class="headerlink" href="#tests-gezielt" title="Permanent link">&para;</a></h3>
<ul>
<li>Enqueue je 1 <code>session</code>- und 1 <code>pdf</code>-Job → beide werden abgearbeitet, Status/Results korrekt, Batch-Fortschritt aktualisiert.</li>
<li>Fehlerpfade: unbekannter <code>job_type</code>, fehlende Pflichtparameter (validiert im Handler) → <code>FAILED</code> + <code>error</code>.</li>
<li>
<p>Parallelitätsgrenze: <code>max_concurrent_workers</code> greift bei gemischten Typen.</p>
</li>
<li>
<p>Änderungen: Analyse-Dokument <code>docs/_analysis/generic_worker.md</code> hinzugefügt.</p>
</li>
<li>Wirkung: Entscheidungsgrundlage und konkreter, minimal-invasiver Migrationsplan für einen generischen Worker mit Registry/Dispatch.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># src/core/processing/registry.py</span>
<span class="n">REGISTRY</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Job</span><span class="p">,</span> <span class="n">SessionJobRepository</span><span class="p">,</span> <span class="n">ResourceCalculator</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="n">job_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">REGISTRY</span><span class="p">[</span><span class="n">job_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_handler</span><span class="p">(</span><span class="n">job_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">REGISTRY</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">job_type</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># im Worker-Thread (ehem. _process_session)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get_handler</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">or</span> <span class="s2">&quot;session&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">handler</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_repo</span><span class="o">.</span><span class="n">update_job_status</span><span class="p">(</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">JobStatus</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="n">JobError</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;UNKNOWN_JOB_TYPE&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_type</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">return</span>
    <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_repo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_calculator</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># registrar</span>
<span class="n">register</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="n">handle_session_job</span><span class="p">)</span>
<span class="n">register</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">handle_pdf_job</span><span class="p">)</span>
</code></pre></div>
<hr />
<p><strong>User</strong></p>
<p>Wie können wir dieses Konzept in der bestehenden mkdocs-Struktur integrieren und dokumentieren?</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich schaue mir kurz die bestehende MkDocs-Konfiguration an, um die Navigation/Struktur zu verstehen und Vorschläge für die Integration (Neue Seite, Nav-Einträge, Querverweise) konkret zu machen. Danach liefere ich präzise Edit-Vorschläge inkl. mkdocs.yml-Änderungen und Dateipfaden.</p>
<p>Ich lege eine neue Seite unter <code>docs/explanations/async-events/generic-worker.md</code> an, die den generischen Worker erklärt und auf die Analyse verweist, und ergänze die Navigation in <code>mkdocs.yml</code> unter Explanations → Async Events um einen Eintrag „Generic Worker“. Anschließend ist die Dokumentation in der MkDocs-Seitenleiste sichtbar.</p>
<div class="highlight"><pre><span></span><code><span class="gu">### Generic Worker (asynchrones Processing für alle Job-Typen)</span>

<span class="gs">**Ziel**</span>: Ein Hintergrund-Worker verarbeitet nicht nur Sessions/Events, sondern auch PDF-, Audio-, Bild-/OCR-, Video- und Transformer-Jobs. Ein Registry/Dispatch-Ansatz nimmt beliebige <span class="sb">`job_type`</span>-s an und arbeitet sie asynchron ab (Status, Progress, Fehler, Batch-Tracking via MongoDB).

<span class="gu">### Architektur auf einen Blick</span>
<span class="k">-</span><span class="w"> </span><span class="gs">**Job-Queue**</span>: MongoDB Collections <span class="sb">`event_jobs`</span> (Jobs) und <span class="sb">`event_batches`</span> (Batches)
<span class="k">-</span><span class="w"> </span><span class="gs">**Worker**</span>: Polling-Loop startet bis <span class="sb">`max_concurrent_workers`</span> Threads; pro Thread läuft ein <span class="sb">`asyncio`</span>-Task
<span class="k">-</span><span class="w"> </span><span class="gs">**Dispatch**</span>: <span class="sb">`job_type -&gt; handler`</span> via Registry; unbekannte Typen werden mit <span class="sb">`FAILED`</span> markiert
<span class="k">-</span><span class="w"> </span><span class="gs">**Batch**</span>: Fortschritt/Status werden zentral aktualisiert

Siehe vertiefte Analyse und Migrationsplan: <span class="sb">`../../_analysis/generic_worker.md`</span>.

<span class="gu">### Konfiguration</span>
<span class="k">-</span><span class="w"> </span>Bestehende Einstellungen in <span class="sb">`config/config.yaml`</span> verwenden:
<span class="w">  </span><span class="k">-</span><span class="w"> </span><span class="sb">`session_worker.active: true`</span>
<span class="w">  </span><span class="k">-</span><span class="w"> </span><span class="sb">`session_worker.max_concurrent: &lt;N&gt;`</span>
<span class="w">  </span><span class="k">-</span><span class="w"> </span><span class="sb">`session_worker.poll_interval_sec: &lt;Sekunden&gt;`</span>
<span class="k">-</span><span class="w"> </span>Hinweis: Die Generalisierung kann weiterhin diese Keys nutzen. Eine spätere Umbenennung zu <span class="sb">`generic_worker`</span> ist optional.

<span class="gu">### Job-Modell (vereinfacht)</span>
<span class="k">-</span><span class="w"> </span><span class="sb">`Job`</span>: <span class="sb">`job_id`</span>, <span class="sb">`job_type`</span>, <span class="sb">`status (pending|processing|completed|failed)`</span>, <span class="sb">`parameters`</span>, <span class="sb">`results`</span>, <span class="sb">`error`</span>, <span class="sb">`progress`</span>, <span class="sb">`batch_id`</span>
<span class="k">-</span><span class="w"> </span>Empfehlung: <span class="sb">`parameters.extra: Dict[str, Any]`</span> einführen, um typ-spezifische Felder (z. B. PDF) sicher zu transportieren.

<span class="gu">### Registry-Pattern (Konzept)</span>
```python
<span class="gh"># job_type → async handler(job, repo, resource_calculator)</span>
register(&quot;session&quot;, handle_session_job)
register(&quot;pdf&quot;, handle_pdf_job)

handler = registry.get(job.job_type or &quot;session&quot;)
await handler(job, repo, resource_calculator)
</code></pre></div>
<h3 id="beispiel-pdf-job-enqueuen">Beispiel: PDF-Job enqueuen<a class="headerlink" href="#beispiel-pdf-job-enqueuen" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;job_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;parameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;extra&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;file_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./tests/samples/sample.pdf&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;extraction_method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;llm_and_native&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;include_images&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;template&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Session&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;context&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;document_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;report&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;language&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;de&quot;</span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Der Worker ruft den PDF-Handler auf, der intern <code>PDFProcessor.process(...)</code> ausführt und die Ergebnisse in <code>results</code> schreibt. Status/Progress/Logs sowie Batch-Updates erfolgen konsistent über das Repository.</p>
<h3 id="migration-inkrementell">Migration (inkrementell)<a class="headerlink" href="#migration-inkrementell" title="Permanent link">&para;</a></h3>
<ul>
<li>Registry ergänzen und <code>SessionWorkerManager</code> intern auf <code>job_type</code>-Dispatch umstellen (Default: <code>session</code>).</li>
<li>PDF-Handler registrieren und Enqueue-Option anbieten (neuer Endpunkt oder Async-Flag im PDF-Endpoint).</li>
<li>Parameter-Generalität über <code>parameters.extra</code>.</li>
</ul>
<h3 id="verweise">Verweise<a class="headerlink" href="#verweise" title="Permanent link">&para;</a></h3>
<ul>
<li>Code: <code>src/core/mongodb/worker_manager.py</code>, <code>src/core/mongodb/repository.py</code>, <code>src/core/models/job_models.py</code>, <code>src/processors/pdf_processor.py</code></li>
<li>Analyse/Plan: <code>../../_analysis/generic_worker.md</code></li>
</ul>
<p>```</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "In Zwischenablage kopiert", "clipboard.copy": "In Zwischenablage kopieren", "search.result.more.one": "1 weiteres Suchergebnis auf dieser Seite", "search.result.more.other": "# weitere Suchergebnisse auf dieser Seite", "search.result.none": "Keine Suchergebnisse", "search.result.one": "1 Suchergebnis", "search.result.other": "# Suchergebnisse", "search.result.placeholder": "Suchbegriff eingeben", "search.result.term.missing": "Es fehlt", "select.version": "Version ausw\u00e4hlen"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
        <script src="../../js/print-site.js"></script>
      
        <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
      
        <script src="../../assets/js/mermaid-init.js"></script>
      
    
  </body>
</html>